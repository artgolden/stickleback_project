---
title: "scATAC data saline sample 1 cluster annotation"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/home/tema/work/skolkovo/fish_project/")
knitr::opts_chunk$set(echo=FALSE, message = FALSE)
```

```{r, results = 'hide'}
library(tidyverse)
library(Signac)
library(Seurat)
library(GenomeInfoDb)
library(patchwork)
set.seed(42)
```


```{r fig.width=15, fig.height=15}
atac1 <- readRDS(file = "data/scATAC/atac1_obj_qc_clusters_calculated_RNA.rds")
# suppressWarnings(plot_gene_distribution(sample_name = "saline_1", sample_obj = atac1))
```

```{r}
# Clusters 2,3,4,6,7,11 - integument tissue
# Clusters 0,1,5 - erythrocytes
# Clusters 8,9,13 - leukocytes 
# Cluster 8,13 - marcophages
# Cluster 7 - ionocytes
# Cluster 2,3,4,6 - integument cells PVCs?
# Cluster 13 - same as cluster 8 in scRNA "rest"
```


```{r}
DimPlot(atac1, label = TRUE)
```

```{r}
atac1@assays[["RNA"]]@counts@Dimnames[[1]][agrep("ENSGACG", atac1@assays[["RNA"]]@counts@Dimnames[[1]])]

```

```{r}
rna.integrated.cluster.rest_annotated <- readRDS( file = "data/rna_integrated_cluster_rest_annotated.RData")
```


```{r}
transfer.anchors <- FindTransferAnchors(
  reference = rna.integrated.cluster.rest_annotated,
  features = rna.integrated.cluster.rest_annotated@assays[["integrated"]]@data@Dimnames[[1]],
  query = atac1,
  reduction = 'cca', 
  reference.assay = "integrated",
  query.assay = "RNA"
)
```

```{r}
celltype.predictions <- TransferData(anchorset = transfer.anchors, refdata = Idents(rna.integrated.cluster.rest_annotated), 
    weight.reduction = atac1[["lsi"]], dims = 1:30)
atac1 <- AddMetaData(atac1, metadata = celltype.predictions)
```

```{r fig.height=12}
DimPlot(atac1, group.by = "predicted.id", pt.size = 2)
```


```{r fig.height=27}
VlnPlot(object = atac1,
  features = c("npsn (1 of many)", "ENSGACG00000020145", "atp1b1b", "pygl", "Ita4h", "atp1a1a.2", "pgd", "msna", "prf1.9", "lck", "mpx", "mpeg1.2", "irf8", "coro1a", "arpc1b", "zgc:64051", "rhcga", "TYMP", "ca15b", "krt99", "krt98", "krt97", "apodb", "fbp2", "ncf1", "ENSGACG00000004882", "g6pd", "sftpbb", "tnfsf14", "ENSGACG00000012769", "ENSGACG00000010720", "cd79a", "mmp9", "taldo1", "tktb", "TSC22D1", "arg2", "S100P", "cdh31", "lgals3b", "hbae5", "ncf2", "krt8", "capn2b"), 
  assay = "RNA", 
  same.y.lims = TRUE
  )
```


```{r fig.height=9}
VlnPlot(object = atac1,
  features = c("cxcl19", "ifit12", "ctsl.1", "ctsc", "acod1"), 
  assay = "RNA", 
  same.y.lims = TRUE
  )
```




